<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Five Forks Fire Weather ‚Äî Single File</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
      /* Five Forks Fire Weather ‚Äî Single-file build
         - Live data: NOAA (NWS) + NASA FIRMS
         - Map tiles: OpenStreetMap via Leaflet
         - Includes Brunswick & Greensville; self-check ensures both render
      */
      :root {
        --bg:#f9fafb;
        --card:#ffffff;
        --muted:#6b7280;
        --shadow:0 2px 6px rgba(0,0,0,.08);
        --ok:#16a34a;
        --warn:#d97706;
        --err:#dc2626;
        --neutral:#475569;
        --header-bg:#1d4ed8;
      }

      /* Dark mode overrides */
      body.dark {
        --bg:#020617;
        --card:#020617;
        --muted:#9ca3af;
        --neutral:#e5e7eb;
        --header-bg:#020617;
        color:#e5e7eb;
      }
      body.dark .badge{
        background:#111827;
        color:var(--neutral);
      }

      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#0f172a}

      .app-header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:.75rem 1rem;
        background:#1d4ed8;
        color:#fff;
      }

      .app-header h1{margin:0;font-size:1.15rem}
      .statusbar{display:flex;gap:.5rem;align-items:center}
      .quick-links{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
      .badge{padding:.25rem .5rem;border-radius:999px;font-size:.8rem;box-shadow:var(--shadow);background:#e5e7eb;color:var(--neutral)}
      .badge.ok{color:#fff;background:var(--ok)}
      .badge.warn{color:#fff;background:var(--warn)}
      .badge.err{color:#fff;background:var(--err)}

      main{display:grid;gap:1rem;padding:1rem}
      .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
      .card{background:var(--card);border-radius:12px;padding:.9rem;box-shadow:var(--shadow)}
      .card h3{margin:0 0 .25rem;display:flex;align-items:center;gap:.4rem;font-size:1.05rem}
      .dim{color:var(--muted);font-size:.9rem}
      .metric{margin:.25rem 0}

      .map-wrap{height:480px;border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
      #map{height:100%;width:100%}
      .legend{background:#fff;padding:6px 8px;border-radius:8px;box-shadow:var(--shadow)}
      .legend .row{display:flex;align-items:center;gap:6px;margin:4px 0}
      .legend .swatch{width:12px;height:12px;border-radius:50%;display:inline-block}

      .alerts{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:.75rem;border-radius:8px;box-shadow:var(--shadow)}
      .app-footer{text-align:center;color:var(--muted);padding:.75rem}

      /* Mobile optimizations */
      @media (max-width:768px){
        .app-header{flex-direction:column;gap:.75rem;padding:1rem}
        .app-header h1{font-size:1.5rem;text-align:center}
        .quick-links{justify-content:center;width:100%}
        .quick-links .badge{font-size:.75rem;padding:.2rem .4rem}
        main{padding:.75rem;gap:.75rem}
        .cards{grid-template-columns:1fr;gap:.75rem}
        .card{padding:.75rem}
        .map-wrap{height:300px;margin-bottom:1rem}
        .app-footer{padding:.5rem;font-size:.85rem}
        .statusbar{flex-wrap:wrap;gap:.35rem;justify-content:center}
        .statusbar .badge{font-size:.7rem;padding:.2rem .4rem}
      }
      @media (min-width:960px){
        main{grid-template-columns:1.2fr 1fr;align-items:start}
        .map-wrap{grid-row:span 2}
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <h1>üî• Five Forks Fire Weather</h1>
      <div class="quick-links">
        <a href="https://firms.modaps.eosdis.nasa.gov/map/" target="_blank" class="badge" style="text-decoration:none">üõ∞Ô∏è FIRMS</a>
        <a href="https://www.weather.gov/akq/" target="_blank" class="badge" style="text-decoration:none">üåßÔ∏è NWS</a>
        <a href="https://maps.app.goo.gl/vcWebUQrrLSY8gX4A" target="_blank" class="badge" style="text-decoration:none">üó∫Ô∏è Equip</a>
        <a href="https://www.windy.com/?37.233,-77.400,8" target="_blank" class="badge" style="text-decoration:none">üå™Ô∏è Windy</a>
        <button id="themeToggle" class="badge">üåô Dark</button>
        <button id="rosCalc" class="badge">üî• R.O.S.</button>
      </div>
    </header>

    <main>
      <section id="cards" class="cards" aria-label="County conditions"></section>
      <section class="map-wrap" aria-label="Hotspots map">
        <div id="map"></div>
      </section>
      <section id="alerts" class="alerts" aria-live="polite" hidden></section>
    </main>

    <footer class="app-footer">
      <div class="statusbar" style="text-align:center;margin-bottom:0.5rem" aria-live="polite">
        
    <!-- R.O.S. Calculator Modal -->
    <div id="rosModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.7);">      <div style="background-color:#fff; margin:5% auto; padding:20px; border-radius:8px; width:90%; max-width:600px;">
<div style="background-color:#fff; margin:2% auto; padding:20px; border-radius:8px; width:90%; max-width:600px; max-height:90vh; overflow-y:auto;">
        <span id="closeModal" style="float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
        <h2>üî• Rate of Spread Calculator</h2>
        <div>
          <label>Wind Speed (mph):</label><input type="number" id="windSpeed" value="5" /><br/><br/>
          
          <label>Fuel Model:</label>
          <select id="fuelModel" style="width:100%; padding:5px; margin-bottom:10px;">
            <option value="1">Model 1 - Short Grass (1 foot)</option>
            <option value="2">Model 2 - Timber (grass and understory)</option>
            <option value="3">Model 3 - Tall Grass (2.5 feet)</option>
            <option value="4">Model 4 - Chaparral (6 feet)</option>
            <option value="5">Model 5 - Brush (2 feet)</option>
            <option value="6">Model 6 - Dormant Brush</option>
            <option value="7">Model 7 - Southern Rough</option>
            <option value="8">Model 8 - Closed Timber Litter</option>
            <option value="9">Model 9 - Hardwood Litter</option>
            <option value="10">Model 10 - Timber (litter and understory)</option>
            <option value="11">Model 11 - Light Logging Slash</option>
            <option value="12">Model 12 - Medium Logging Slash</option>
            <option value="13">Model 13 - Heavy Logging Slash</option>
          </select><br/>
          <button type="button" onclick="showFuelModelInfo()" style="padding:5px 10px; background:#17a2b8; color:white; border:none; border-radius:4px; cursor:pointer;">‚ÑπÔ∏è Info</button><br/><br/>

          <label>Slope (%):</label><input type="number" id="slope" value="0" /><br/><br/>
          <label>Fuel Moisture (%):</label><input type="number" id="fuelMoisture" value="8" /><br/><br/>
          
          <button type="button" onclick="calculateMoisture()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer;">Calculate Moisture</button>
          <button onclick="calculateROS()" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">Calculate</button>
        </div>
        <div id="results" style="margin-top:20px; padding:10px; background:#f0f0f0; border-radius:4px;"></div>
      </div>
    </div>

        <span id="status-noaa" class="badge" title="NOAA Weather API">NOAA ‚è≥</span>
        <span id="status-firms" class="badge" title="NASA FIRMS GeoJSON">FIRMS ‚è≥</span>
        <span id="status-tiles" class="badge" title="Map tiles (OSM)">Tiles ‚è≥</span>
      </div>
      <small>Data: NOAA NWS & NASA FIRMS ¬∑ Auto-refresh hourly</small>
    </footer>

    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <script>
      /**
       * Single-file app logic
       * - Verifies connectivity (badges) for NOAA, FIRMS, OSM tiles
       * - Draws hotspots + 30 km buffers + county centers
       * - Builds cards per county using NOAA hourly forecast
       */

      // ----------------------------- Config ---------------------------------
      const COUNTIES = [
        { name: "Amelia",        lat: 37.342, lon: -77.980 },
        { name: "Nottoway",      lat: 37.142, lon: -78.089 },
        { name: "Dinwiddie",     lat: 37.077, lon: -77.587 },
        { name: "Prince George", lat: 37.221, lon: -77.288 },
        { name: "Brunswick",     lat: 36.758, lon: -77.847 },
        { name: "Greensville",   lat: 36.686, lon: -77.542 },
      ];

      const BUFFER_KM = 30; // conservative proximity window for nearby hotspots

      // FIRMS endpoint referenced in the original file (appears to be geojson)
      const FIRMS_URL = "https://firms.modaps.eosdis.nasa.gov/api/area/geojson/6ec6f9501dda0774853f77ee933238ed/VIIRS_NOAA20_NRT/-79,36,-77,38/1"
  
      // --------------------------- Status Helpers ----------------------------
      function setBadge(id, state, label){
        const el = document.getElementById(id);
        if(!el) return;
        el.classList.remove('ok','warn','err');
        if (state) el.classList.add(state);
        if(label) el.textContent = label;
      }
      function showAlert(msg){ const box = document.getElementById('alerts'); if(!box) return; box.hidden = false; box.textContent = msg; }

      // ----------------------------- Map Init --------------------------------
      let map, layers = {};
      function initMap(){
        map = L.map('map');
        const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '¬© OpenStreetMap contributors' });
        tiles.on('load', () => setBadge('status-tiles','ok','Tiles ‚úÖ'));
        tiles.on('tileerror', () => setBadge('status-tiles','err','Tiles ‚ùå'));
        tiles.addTo(map);

        L.control.scale({ metric: false }).addTo(map);
        layers.hotspots = L.layerGroup().addTo(map);
        layers.buffers  = L.layerGroup().addTo(map);
        layers.centers  = L.layerGroup().addTo(map);

        const overlays = { 'üî• Hotspots': layers.hotspots, 'üü¢ Buffers (30 km)': layers.buffers, 'üìç County centers': layers.centers };
        L.control.layers({}, overlays, { collapsed: true }).addTo(map);

        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = () => {
          const div = L.DomUtil.create('div','legend');
          div.innerHTML = `
            <div class="row"><span class="swatch" style="background:#ef4444"></span>Hotspot</div>
            <div class="row"><span class="swatch" style="background:#22c55e"></span>30 km buffer</div>
            <div class="row"><span class="swatch" style="background:#0ea5e9"></span>County center</div>`;
          return div;
        };
        legend.addTo(map);
      }

      // --------------------------- Data Fetching -----------------------------
      // FIRMS: attempt to parse JSON (geojson); if that fails, fall back to CSV parsing
      async function fetchFIRMS(){
        try {
          const res = await fetch(FIRMS_URL, { cache: 'no-store' });
          if(!res.ok) throw new Error(`FIRMS status ${res.status}`);
          const text = await res.text();

          // Try JSON first (geojson endpoint expected)
          try {
            const geojson = JSON.parse(text);
            if (geojson && Array.isArray(geojson.features)) {
              setBadge('status-firms','ok','FIRMS ‚úÖ');
              return geojson;
            }
            // If parsed value isn't valid, fall through to CSV fallback
          } catch (e) {
            // not JSON ‚Äî continue to CSV parsing below
          }

          // CSV fallback parsing (handles some FIRMS endpoints that return CSV)
          const lines = text.split('\n').map(l => l.trim()).filter(l => l);
          if (lines.length <= 1) {
            setBadge('status-firms','ok','FIRMS ‚úÖ');
            return { type: 'FeatureCollection', features: [] };
          }
          const headers = lines[0].split(',').map(h => h.trim());
          const data = lines.slice(1).map(line => {
            const values = line.split(',');
            const obj = {};
            headers.forEach((header, i) => obj[header] = values[i]);
            return obj;
          });
          const features = data.map(row => ({
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [parseFloat(row.longitude), parseFloat(row.latitude)]
            },
            properties: row
          })).filter(f => Number.isFinite(f.geometry.coordinates[0]) && Number.isFinite(f.geometry.coordinates[1]));

          setBadge('status-firms','ok','FIRMS ‚úÖ');
          return { type: 'FeatureCollection', features };
        } catch (e) {
          console.warn('FIRMS fetch failed', e);
          setBadge('status-firms','err','FIRMS ‚ùå');
          return { type:'FeatureCollection', features: [] };
        }
      }

      // NOAA: include User-Agent (per api.weather.gov guidance). Replace contact URL/email as appropriate.
      const NOAA_HEADERS = {
        'Accept': 'application/geo+json',
        'User-Agent': 'Five-Forks-Fire-Weather (https://github.com/jamesdcochran-oss/Five-Forks-Fire-Weather)'
      };

      async function fetchNOAAHourly(lat, lon){
        try {
          const p = await fetch(`https://api.weather.gov/points/${lat},${lon}`, { headers: NOAA_HEADERS });
          if(!p.ok) throw new Error(`points status ${p.status}`);
          const meta = await p.json();
          const hourlyUrl = meta?.properties?.forecastHourly;
          if(!hourlyUrl) throw new Error('missing forecastHourly');
          const f = await fetch(hourlyUrl, { cache: 'no-store', headers: NOAA_HEADERS });
          if(!f.ok) throw new Error(`hourly status ${f.status}`);
          const hourly = await f.json();
          setBadge('status-noaa','ok','NOAA ‚úÖ');
          return hourly?.properties?.periods?.[0] ?? null;
        } catch(e) {
          console.warn('NOAA fetch failed', e);
          setBadge('status-noaa','warn','NOAA ‚ö†Ô∏è'); // continue rendering with N/A
          return null;
        }
      }

      // --------------------------- Rendering ---------------------------------
      function renderCardsStart(){ document.getElementById('cards').innerHTML = ''; }

      function renderCountyCard({ name }, now, hotspotCount){
        const el = document.createElement('article');
        el.className = 'card';
        const summary = now ? `${now.temperature}\u00B0F ‚Ä¢ ${now.relativeHumidity?.value ?? 'N/A'}% RH ‚Ä¢ ${now.windSpeed ?? 'N/A'} ${now.windDirection ?? ''}` : 'N/A';
        const label   = now?.shortForecast ?? 'N/A';
        el.innerHTML = `
          <h3>${label.includes('Thunder') ? '‚õàÔ∏è' : 'üå§Ô∏è'} ${name}</h3>
          <div class="dim">Class: ${label}</div>
          <div class="metric">Wx: ${summary}</div>
          <div class="metric">Hotspots (‚â§ ${BUFFER_KM} km): <strong>${hotspotCount}</strong></div>
        `;
        document.getElementById('cards').appendChild(el);
      }

      function drawBuffersAndCenters(){
        layers.buffers.clearLayers();
        layers.centers.clearLayers();

        const circles = [];
        for(const c of COUNTIES){
          const circle = turf.circle([c.lon, c.lat], BUFFER_KM, { units: 'kilometers', steps: 64 });
          L.geoJSON(circle, { style: { color:'#22c55e', weight:1, fillOpacity:0.08 } }).addTo(layers.buffers);
          circles.push(circle);
          L.circleMarker([c.lat,c.lon], { radius:5, color:'#0ea5e9', fillColor:'#0ea5e9', fillOpacity:.9 }).bindTooltip(c.name).addTo(layers.centers);
        }
        const bbox = turf.bbox(turf.featureCollection(circles));
        const sw = [bbox[1], bbox[0]]; const ne = [bbox[3], bbox[2]];
        map.fitBounds([sw, ne], { padding:[30,30] });
      }

      function drawHotspots(geojson){
        layers.hotspots.clearLayers();
        if(!geojson?.features?.length) return;
        L.geoJSON(geojson, {
          filter: f => f && f.geometry && f.geometry.type === 'Point',
          pointToLayer: (f, latlng) => {
            const marker = L.circleMarker(latlng, {
              radius:4, color:'#ef4444', fillColor:'#ef4444', fillOpacity:.85, weight:1
            });
            const props = f.properties || {};
            const time = props.acq_date ? `${props.acq_date} ${props.acq_time ?? ''}` : (props.time ?? '');
            const instrument = props.instrument || props.satellite || '';
            const confidence = props.confidence ? `‚Ä¢ ${props.confidence}` : (props.confidence_level ? `‚Ä¢ ${props.confidence_level}` : '');
            const popup = `<strong>üî• Active fire</strong><br>${time}<br>${instrument} ${confidence}`.trim();
            marker.bindPopup(popup);
            return marker;
          }
        }).addTo(layers.hotspots);
      }

      // ------------------------------ Logic ----------------------------------
      async function refresh(){
        renderCardsStart();
        const firms = await fetchFIRMS();
        drawHotspots(firms);
        drawBuffersAndCenters();

        const features = firms?.features ?? [];
        for(const county of COUNTIES){
          const now = await fetchNOAAHourly(county.lat, county.lon);
          const buffer = turf.circle([county.lon, county.lat], BUFFER_KM, { units: 'kilometers' });
          const count = features.reduce((acc, f) => {
            if(!f.geometry || f.geometry.type !== 'Point') return acc;
            const [x,y] = f.geometry.coordinates; // lon, lat
            return acc + (turf.booleanPointInPolygon(turf.point([x,y]), buffer) ? 1 : 0);
          }, 0);
          renderCountyCard(county, now, count);
        }

        // Self-check for Brunswick & Greensville
        const names = [...document.querySelectorAll('#cards .card h3')].map(h => h.textContent);
        if (!names.some(t => t.includes('Brunswick')) || !names.some(t => t.includes('Greensville'))){
          showAlert('Self-check failed: Brunswick and/or Greensville not rendered.');
        } else {
          // hide alert if present
          const box = document.getElementById('alerts'); if (box) { box.hidden = true; }
        }
      }

      // ------------------------------ Boot -----------------------------------
      window.addEventListener('DOMContentLoaded', () => {
        initMap();
        refresh();
        setInterval(refresh, 60 * 60 * 1000); // hourly
      });
    </script>

    <script>
      // Theme toggle
      const toggle = document.getElementById('themeToggle');
      if (toggle) {
        toggle.addEventListener('click', () => {
          document.body.classList.toggle('dark');
          toggle.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è Light' : 'üåô Dark';
        });
      }
    </script>

    <script src="fire-behavior.js"></script>
    <script src="fuel-models.js"></script>
    <script>
      // R.O.S. Calculator Modal Controls
      const rosCalcBtn = document.getElementById('rosCalc');
      const rosModal = document.getElementById('rosModal');
      const closeModal = document.getElementById('closeModal');
      
      if (rosCalcBtn) {
        rosCalcBtn.addEventListener('click', () => {
          rosModal.style.display = 'block';
        });
      }
      
      if (closeModal) {
        closeModal.addEventListener('click', () => {
          rosModal.style.display = 'none';
        });
      }
      
      window.onclick = function(event) {
        if (event.target == rosModal) {
          rosModal.style.display = 'none';
        }
      };
      
      // Show fuel model information
      function showFuelModelInfo() {
        const fuelModel = parseInt(document.getElementById('fuelModel').value);
        if (FUEL_MODELS[fuelModel]) {
          const model = FUEL_MODELS[fuelModel];
          alert(`Fuel Model ${fuelModel}: ${model.name}\n\n${model.description}\n\nTypical: ${model.typical}`);
        } else {
          alert('Please select a valid fuel model (1-13)');
        }
      }
      
      // Calculate fuel moisture from current weather
      function calculateMoisture() {
        const tempF = 70;
        const relHumidity = 45;
        
        const moistures = FuelMoistureCalculator.estimateFromWeather({
          tempF: tempF,
          relHumidity: relHumidity
        });
        
        document.getElementById('fuelMoisture').value = moistures.oneHour;
        
        alert(`Estimated Fuel Moistures (based on T=${tempF}¬∞F, RH=${relHumidity}%):\n\n` +
              `1-hour: ${moistures.oneHour}%\n` +
              `10-hour: ${moistures.tenHour}%\n` +
              `100-hour: ${moistures.hundredHour}%\n` +
              `Live Herb: ${moistures.liveHerbaceous}%\n` +
              `Live Stem: ${moistures.liveStem}%\n\n` +
              `1-hour moisture has been set in calculator.`);
      }
      
      // Calculate Rate of Spread
      function calculateROS() {
        const windSpeed = parseFloat(document.getElementById('windSpeed').value);
        const fuelModel = parseInt(document.getElementById('fuelModel').value);
        const slope = parseFloat(document.getElementById('slope').value);
        const moisture = parseFloat(document.getElementById('fuelMoisture').value);
        
        const results = window.FireBehavior.predictFireBehavior({
          windSpeed: windSpeed,
          fuelMoisture: moisture,
          slope: slope,
          fuelModel: fuelModel.toString()
        });    
        
        document.getElementById('results').innerHTML = `
          <h3>Results:</h3>
          <p><strong>Rate of Spread:</strong> ${results.rateOfSpread.chainsPerHour.toFixed(2)} chains/hour</p>
          <p><strong>Flame Length:</strong> ${results.flameLength.feet.toFixed(1)} feet</p>
          <p><strong>Fireline Intensity:</strong> ${results.firelineIntensity.toFixed(0)} BTU/ft/s</p>
        `;
      }
    </script>
  </body>
</html>
